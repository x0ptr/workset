<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Code Sprint Board — Backlog & Focus Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      /* Dracula Official */
      --bg:#282a36;
      --current:#44475a;
      --fg:#f8f8f2;
      --comment:#6272a4;
      --cyan:#8be9fd;
      --green:#50fa7b;
      --orange:#ffb86c;
      --pink:#ff79c6;
      --purple:#bd93f9;
      --red:#ff5555;
      --yellow:#f1fa8c;

      --bs-body-bg: var(--bg);
      --bs-body-color: var(--fg);
      --bs-border-color: var(--current);
      --card-bg: #2b2d3a;
    }
    html, body { height: 100%; }
    body{ display:flex; flex-direction:column; min-height:100vh; background:var(--bg); color:var(--fg); }
    .navbar{ background: linear-gradient(90deg, #22232e, #2b2d3a); border-bottom:1px solid var(--current); }
    .brand-badge{ background:var(--purple); color:#0c0c12; font-weight:700; border-radius:.35rem; padding:.15rem .4rem; }
    .pill{ border:1px dashed var(--comment); border-radius:.5rem; padding:.35rem .6rem; color:var(--comment); }
    .btn-drac{ background:var(--current); color:var(--fg); border-color:var(--current); }
    .btn-drac:hover{ filter:brightness(1.15); color:var(--fg); }
    .btn-ghost{ background:transparent; border:1px solid var(--current); color:var(--fg); }
    .btn-ghost:hover{ background:var(--current); }
    .btn-focus{ background:var(--green); color:#0b0e12; border:none; }
    .btn-stop{ background:var(--red); color:#0b0e12; border:none; }
    .card{ background:var(--card-bg); border:1px solid var(--current); }
    .card-header{ background:#232532; border-bottom:1px solid var(--current); }
    .task{ background:#232532; border:1px solid var(--current); border-radius:.6rem; padding:.5rem .6rem; display:flex; gap:.5rem; align-items:center; user-select:none; }
    .task.dragging{ opacity:.55; transform:scale(0.98); }
    .task.done .text{ text-decoration:line-through; color:var(--comment); }
    .task .text[contenteditable="true"]{ outline:2px solid var(--purple); border-radius:.25rem; padding:.1rem .2rem; }
    .task .badge{ background:transparent; border:1px solid var(--comment); color:var(--comment); }
    .list-drop{ min-height:2.2rem; gap:.5rem; display:flex; flex-direction:column; }
    .list-drop.hover{ outline:2px dashed var(--purple); border-radius:.6rem; padding:.4rem; }
    .muted{ color:var(--comment); }
    .divider{ border-top:1px dashed var(--current); }
    .searchbox{ background:#232532; border:1px solid var(--current); color:var(--fg); }
    .searchbox::placeholder{ color:var(--comment); }
    .switch-mini .form-check-input{ width:2.2rem; height:1.2rem; background:#1e2030; border:1px solid var(--current); }
    .kbd{ background:#1e2030; border:1px solid var(--current); border-bottom-width:3px; padding:.1rem .35rem; border-radius:.2rem; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .link-muted{ color:var(--comment); text-decoration:none; }
    .link-muted:hover{ color:var(--fg); }
    /* Session mode */
    body.session .backlog-pane,
    body.session .organize-toolbar,
    body.session .export-card,
    body.session .info-quickstart{ display:none !important; }
    body.session .today-pane{ width:100% !important; }
    body.session .navbar{ border-bottom:2px solid var(--green); }
    /* Priority colors */
    .pri-0{ color:var(--comment); }
    .pri-1{ color:var(--yellow); }
    .pri-2{ color:var(--pink); }
    /* Tag chip */
    .chip{ border:1px solid var(--comment); color:var(--comment); border-radius:999px; padding:0 .4rem; font-size:.75rem; }
    /* File input hidden; styled label */
    #fileInput{ display:none; }
    .file-label{ cursor:pointer; }
    /* Footer (Dracula-themed, sticky bottom) */
    .footer { 
          background:#20222c; 
          color:var(--fg); 
          border-top:1px solid var(--current);
        }
        .footer a { color: var(--cyan); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .footer .label { color: var(--comment); text-transform: uppercase; letter-spacing:.05em; }

  </style>
</head>

<body>
  <!-- Top bar -->
  <nav class="navbar navbar-expand px-3 py-2">
    <div class="d-flex align-items-center gap-2">
      <span class="brand-badge">CSB</span>
      <strong>Code Sprint Board</strong>
      <span class="ms-2 pill small"><i class="bi bi-moon-stars me-1"></i>Dracula</span>
    </div>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="todayCount" class="badge rounded-pill" style="background:var(--purple);">0 Today</span>
      <span id="backlogCount" class="badge rounded-pill" style="background:var(--orange); color:#0b0e12;">0 Backlog</span>

      <div class="vr mx-2"></div>

      <button id="toggleSessionBtn" class="btn btn-focus btn-sm">
        <i class="bi bi-play-fill me-1"></i><span>Start Session</span>
      </button>

      <div class="dropdown">
        <button class="btn btn-ghost btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-box-arrow-down me-1"></i>Export/Import
        </button>
        <div class="dropdown-menu dropdown-menu-end p-3 text-body" style="min-width:22rem;">
          <div class="text-light">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <strong class="small">Backup (Base64)</strong>
              <span class="small muted">localStorage-safe</span>
            </div>
            <textarea id="exportArea" rows="4" class="form-control searchbox mb-2" placeholder="Base64 will appear here on Export..."></textarea>
            <div class="d-flex gap-2 flex-wrap">
              <button id="btnExport" class="btn btn-drac btn-sm"><i class="bi bi-clipboard2-data me-1"></i>Export</button>
              <button id="btnCopy" class="btn btn-ghost btn-sm"><i class="bi bi-clipboard-check me-1"></i>Copy</button>
              <button id="btnDownload" class="btn btn-ghost btn-sm"><i class="bi bi-filetype-txt me-1"></i>Download .txt</button>
              <button id="btnImport" class="btn btn-ghost btn-sm"><i class="bi bi-cloud-arrow-up me-1"></i>Import</button>
              <label for="fileInput" class="btn btn-ghost btn-sm file-label"><i class="bi bi-upload me-1"></i>Upload .txt</label>
              <input type="file" id="fileInput" accept=".txt,text/plain" />
            </div>
            <div class="form-text text-light mt-2">
              Tip: Import will replace current data (you'll be asked). You can also drop the .txt file anywhere in the page.
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Info / Hints -->
  <section class="container py-3 info-quickstart">
    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body py-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="h5 mb-0">Plan in Backlog, Focus in Session</div>
                <div class="small muted">Type tasks with optional #tags and !! for priority. Press Enter to add. Drag to reorder. Toggle <i class="bi bi-rocket-takeoff"></i> to mark for Today.</div>
              </div>
              <div class="text-end small">
                <div class="mb-1"><span class="kbd">S</span> Start/Stop</div>
                <div><span class="kbd">N</span> New Task • <span class="kbd">T</span> Toggle Today • <span class="kbd">.</span> Cycle Priority</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card export-card">
          <div class="card-body py-3">
            <div class="small muted mb-1">Session mode hides everything except Today. Stop the session to reorganize or import/export.</div>
            <div class="divider my-2"></div>
            <div class="d-flex gap-2 flex-wrap">
              <span class="chip"><i class="bi bi-hash me-1"></i>Tags</span>
              <span class="chip"><i class="bi bi-lightning me-1"></i>!! priority</span>
              <span class="chip"><i class="bi bi-filter me-1"></i>Filter</span>
              <span class="chip"><i class="bi bi-arrows-move me-1"></i>Drag</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main class="container pb-5">
    <div class="row g-3">
      <!-- Backlog -->
      <div class="col-lg-7 backlog-pane">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between py-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-journal-code me-1" style="color:var(--orange)"></i>
              <strong>Backlog</strong>
            </div>
            <div class="d-flex align-items-center gap-2 organize-toolbar">
              <input id="search" class="form-control form-control-sm searchbox" placeholder="Filter by text or #tag..." />
              <div class="form-check form-switch switch-mini">
                <input class="form-check-input" type="checkbox" id="toggleDoneBacklog">
                <label for="toggleDoneBacklog" class="form-check-label small">Hide done</label>
              </div>
            </div>
          </div>
          <div class="card-body">
            <form id="addForm" class="mb-3">
              <div class="input-group">
                <span class="input-group-text searchbox"><i class="bi bi-plus-lg"></i></span>
                <input id="taskInput" class="form-control searchbox" placeholder="Add a task... use #tags and !! for priority" autocomplete="off">
                <button class="btn btn-drac" type="submit">Add</button>
              </div>
              <div class="form-text text-light">Examples: "Refactor auth #backend !!" • "Fix CSS glitches #ui"</div>
            </form>

            <div id="backlogList" class="list-drop" aria-label="Backlog list"></div>
          </div>
        </div>
      </div>

      <!-- Today -->
      <div class="col-lg-5 today-pane">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between py-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-rocket-takeoff-fill" style="color:var(--green)"></i>
              <strong>Today</strong>
            </div>
            <div class="d-flex align-items-center gap-2">
              <div class="form-check form-switch switch-mini">
                <input class="form-check-input" type="checkbox" id="toggleDoneToday">
                <label for="toggleDoneToday" class="form-check-label small">Hide done</label>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="todayList" class="list-drop" aria-label="Today list"></div>
            <div id="emptyToday" class="text-center muted py-3" style="display:none;">
              <i class="bi bi-stars me-1"></i>Select tasks from Backlog with the rocket to prepare your session.
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Templates -->
  <template id="taskTemplate">
    <div class="task" draggable="true">
      <input type="checkbox" class="form-check-input me-1 chk">
      <span class="text flex-grow-1" role="textbox"></span>
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-flag-fill pri pri-0" title="Priority"></i>
        <span class="small tags d-none"></span>
        <button class="btn btn-sm btn-ghost btn-today" title="Toggle Today">
          <i class="bi bi-rocket-takeoff"></i>
        </button>
        <button class="btn btn-sm btn-ghost btn-edit" title="Edit">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-sm btn-ghost btn-del" title="Delete">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </template>

  <!-- Session footer hint -->
  <footer class="text-center py-3 small muted">
    <a class="link-muted" href="#" id="showShortcuts"><i class="bi bi-keyboard"></i> Keyboard shortcuts</a>
    <span class="mx-2">•</span>
    <span id="clock"></span>
  </footer>


<footer class="footer mt-auto py-3">
  <div class="container small d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div>
      <span class="label me-2">Imprint:</span>
      <span>Lars Feldeisen</span>
    </div>

    <div>
      <i class="bi bi-github me-1"></i>
      <a href="https://github.com/x0ptr" target="_blank" rel="noopener">github.com/x0ptr</a>
    </div>

    <div class="text-muted">
      Share or Save it with <kbd>Ctrl</kbd>+<kbd>S</kbd> and use local
    </div>
  </div>
</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- Utilities ----------
    const $ = (sel, el=document)=>el.querySelector(sel);
    const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
    const STORAGE_KEY = 'csb_data_v1';
    const UI_KEY = 'csb_ui_v1';

    const nowStamp = ()=> new Date().toISOString();

    // Robust Base64 for UTF-8
    function toBase64(str){
      const bytes = new TextEncoder().encode(str);
      let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin);
    }
    function fromBase64(b64){
      const bin = atob(b64);
      const bytes = new Uint8Array([...bin].map(c=>c.charCodeAt(0)));
      return new TextDecoder().decode(bytes);
    }

    // ---------- State ----------
    let state = {
      tasks: [], // {id, text, tags[], pri:0-2, today:bool, done:bool, created, updated}
      orderBacklog: [],
      orderToday: [],
      session: false
    };
    let ui = {
      hideDoneBacklog:false,
      hideDoneToday:false,
      filter:''
    };

    // ---------- Persistence ----------
    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      localStorage.setItem(UI_KEY, JSON.stringify(ui));
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ state = JSON.parse(raw); }
        const rawUI = localStorage.getItem(UI_KEY);
        if(rawUI){ ui = Object.assign(ui, JSON.parse(rawUI)); }
      }catch(e){ console.warn('Load error', e); }
    }

    // ---------- ID ----------
    function nextId(){ return 't'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }

    // ---------- Parsing ----------
    function parseTaskInput(text){
      const pri = (text.match(/!{2,}/)? Math.min(2, text.match(/!+/)[0].length-1) : 0);
      text = text.replace(/!+/g,'').trim();
      const tags = (text.match(/#([\p{L}\p{N}_-]+)/gu)||[]).map(t=>t.slice(1).toLowerCase());
      // Keep tags in text for inline display; no removal.
      return {text, tags:[...new Set(tags)], pri};
    }

    // ---------- Rendering ----------
    function render(){
      // Filter
      const filter = ui.filter.trim().toLowerCase();
      const testFilter = (task)=>{
        if(!filter) return true;
        if(filter.startsWith('#')){
          const ft = filter.slice(1);
          return task.tags.some(t=>t.includes(ft));
        }
        return task.text.toLowerCase().includes(filter) || task.tags.some(t=>('#'+t).includes(filter));
      };

      // Partition
      const backlog = state.tasks.filter(t=>!t.today).filter(testFilter).filter(t=> ui.hideDoneBacklog ? !t.done : true);
      const today = state.tasks.filter(t=>t.today).filter(testFilter).filter(t=> ui.hideDoneToday ? !t.done : true);

      // Order
      const orderBy = (list, orderArr)=>{
        const map = new Map(list.map(t=>[t.id,t]));
        const ordered = orderArr.map(id=>map.get(id)).filter(Boolean);
        const unordered = list.filter(t=>!orderArr.includes(t.id));
        return [...ordered, ...unordered];
      };
      const backlogOrdered = orderBy(backlog, state.orderBacklog);
      const todayOrdered   = orderBy(today, state.orderToday);

      // Clear
      $('#backlogList').replaceChildren();
      $('#todayList').replaceChildren();

      if(todayOrdered.length===0) $('#emptyToday').style.display='block';
      else $('#emptyToday').style.display='none';

      // Render helpers
      const fragB = document.createDocumentFragment();
      backlogOrdered.forEach(t=> fragB.appendChild(renderTask(t)));
      $('#backlogList').appendChild(fragB);

      const fragT = document.createDocumentFragment();
      todayOrdered.forEach(t=> fragT.appendChild(renderTask(t)));
      $('#todayList').appendChild(fragT);

      // Counts
      $('#backlogCount').textContent = `${state.tasks.filter(t=>!t.today).length} Backlog`;
      $('#todayCount').textContent = `${state.tasks.filter(t=>t.today).length} Today`;

      // Session mode
      document.body.classList.toggle('session', !!state.session);
      const btn = $('#toggleSessionBtn');
      if(state.session){
        btn.classList.remove('btn-focus'); btn.classList.add('btn-stop');
        btn.innerHTML = '<i class="bi bi-stop-circle me-1"></i><span>Stop Session</span>';
      }else{
        btn.classList.add('btn-focus'); btn.classList.remove('btn-stop');
        btn.innerHTML = '<i class="bi bi-play-fill me-1"></i><span>Start Session</span>';
      }

      // UI toggles
      $('#toggleDoneBacklog').checked = ui.hideDoneBacklog;
      $('#toggleDoneToday').checked = ui.hideDoneToday;
      $('#search').value = ui.filter;

      save();
    }

    function renderTask(task){
      const tpl = $('#taskTemplate').content.firstElementChild.cloneNode(true);
      const root = tpl;
      root.dataset.id = task.id;
      if(task.done) root.classList.add('done');

      // checkbox
      const chk = $('.chk', root);
      chk.checked = task.done;
      chk.addEventListener('change', ()=>{
        task.done = chk.checked; task.updated = nowStamp(); render();
      });

      // text
      const txt = $('.text', root);
      txt.textContent = task.text;
      txt.addEventListener('dblclick',()=> startEdit(txt, task));
      // quick single-click edit in backlog only
      $('.btn-edit', root).addEventListener('click',()=> startEdit(txt, task));

      // priority
      const pri = $('.pri', root);
      pri.classList.remove('pri-0','pri-1','pri-2');
      pri.classList.add('pri-'+task.pri);
      pri.addEventListener('click', ()=>{
        task.pri = (task.pri+1)%3; task.updated = nowStamp(); render();
      });

      // today toggle
      const btnToday = $('.btn-today', root);
      btnToday.innerHTML = task.today
        ? '<i class="bi bi-rocket-takeoff-fill" style="color:var(--green)"></i>'
        : '<i class="bi bi-rocket-takeoff"></i>';
      btnToday.addEventListener('click', ()=>{
        task.today = !task.today; task.updated = nowStamp();
        // move id between orders
        if(task.today){
          // remove from backlog order; push to today
          state.orderBacklog = state.orderBacklog.filter(id=>id!==task.id);
          if(!state.orderToday.includes(task.id)) state.orderToday.push(task.id);
        }else{
          state.orderToday = state.orderToday.filter(id=>id!==task.id);
          if(!state.orderBacklog.includes(task.id)) state.orderBacklog.push(task.id);
        }
        render();
      });

      // delete
      $('.btn-del', root).addEventListener('click', ()=>{
        if(confirm('Delete this task?')){
          state.tasks = state.tasks.filter(x=>x.id!==task.id);
          state.orderBacklog = state.orderBacklog.filter(id=>id!==task.id);
          state.orderToday = state.orderToday.filter(id=>id!==task.id);
          render();
        }
      });

      // tags (inline chips when hovering)
      if(task.tags?.length){
        const span = document.createElement('span');
        span.className = 'd-flex align-items-center gap-1';
        task.tags.forEach(t=>{
          const chip = document.createElement('span'); chip.className='badge rounded-pill';
          chip.textContent = '#'+t;
          span.appendChild(chip);
        });
        $('.tags', root).replaceWith(span);
      }

      // drag
      root.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', task.id);
        e.dataTransfer.effectAllowed='move';
        root.classList.add('dragging');
      });
      root.addEventListener('dragend', ()=> root.classList.remove('dragging'));

      return root;
    }

    function startEdit(el, task){
      if(state.session) return; // read-only in session for edits
      el.setAttribute('contenteditable','true'); el.focus();
      const sel = window.getSelection(); const range = document.createRange();
      range.selectNodeContents(el); sel.removeAllRanges(); sel.addRange(range);
      const finish = ()=>{
        el.removeAttribute('contenteditable');
        const val = el.textContent.trim();
        if(!val){ el.textContent = task.text; return; }
        const parsed = parseTaskInput(val);
        task.text = parsed.text;
        task.tags = parsed.tags;
        if(parsed.pri>task.pri) task.pri = parsed.pri; // allow bump via !!
        task.updated = nowStamp(); render();
      };
      el.addEventListener('blur', finish, {once:true});
      el.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
        if(e.key==='Escape'){ e.preventDefault(); el.textContent = task.text; el.blur(); }
      }, {once:true});
    }

    // ---------- DnD targets ----------
    function setupDrops(){
      ['backlogList','todayList'].forEach(listId=>{
        const list = document.getElementById(listId);
        list.addEventListener('dragover',(e)=>{
          e.preventDefault(); list.classList.add('hover');
          const afterElement = getDragAfterElement(list, e.clientY);
          const dragging = document.querySelector('.dragging');
          if(!dragging) return;
          if(afterElement==null){
            list.appendChild(dragging);
          }else{
            list.insertBefore(dragging, afterElement);
          }
        });
        list.addEventListener('dragleave',()=> list.classList.remove('hover'));
        list.addEventListener('drop',(e)=>{
          e.preventDefault(); 
          list.classList.remove('hover');
          
          const draggedId = e.dataTransfer.getData('text/plain');
          if(!draggedId) return;
          
          const task = state.tasks.find(t => t.id === draggedId);
          if(!task) return;
          
          // Determine if we're moving to backlog or today based on the list ID
          const isBacklogTarget = (listId === 'backlogList');
          const isTodayTarget = (listId === 'todayList');
          
          // Update the task's today flag
          if(isBacklogTarget && task.today) {
            // Moving FROM today TO backlog - remove today flag
            task.today = false;
            task.updated = nowStamp();
            // Remove from today order, add to backlog order
            state.orderToday = state.orderToday.filter(id => id !== draggedId);
            if(!state.orderBacklog.includes(draggedId)) {
              state.orderBacklog.push(draggedId);
            }
          } else if(isTodayTarget && !task.today) {
            // Moving FROM backlog TO today - add today flag
            task.today = true;
            task.updated = nowStamp();
            // Remove from backlog order, add to today order
            state.orderBacklog = state.orderBacklog.filter(id => id !== draggedId);
            if(!state.orderToday.includes(draggedId)) {
              state.orderToday.push(draggedId);
            }
          }
          
          // Update the order based on current DOM position within the target list
          const currentIds = $$('.task', list).map(x => x.dataset.id);
          if(isBacklogTarget) {
            state.orderBacklog = currentIds;
          } else if(isTodayTarget) {
            state.orderToday = currentIds;
          }
          
          render();
        });
      });
    }
    
    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.task:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){ return {offset, element: child}; }
        else return closest;
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    // ---------- Add task ----------
    $('#addForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const input = $('#taskInput');
      const raw = input.value.trim();
      if(!raw) return;
      const {text, tags, pri} = parseTaskInput(raw);
      const t = { id: nextId(), text, tags, pri, today:false, done:false, created:nowStamp(), updated:nowStamp() };
      state.tasks.push(t);
      state.orderBacklog.push(t.id);
      input.value='';
      render();
    });

    // Filter + hide done toggles
    $('#search').addEventListener('input', (e)=>{ ui.filter = e.target.value; render(); });
    $('#toggleDoneBacklog').addEventListener('change', (e)=>{ ui.hideDoneBacklog = e.target.checked; render(); });
    $('#toggleDoneToday').addEventListener('change', (e)=>{ ui.hideDoneToday = e.target.checked; render(); });

    // Start/Stop Session
    $('#toggleSessionBtn').addEventListener('click', ()=>{
      state.session = !state.session; render();
    });

    // ---------- Export / Import ----------
    function exportBase64(){
      const payload = JSON.stringify(state);
      const b64 = toBase64(payload);
      $('#exportArea').value = b64;
      return b64;
    }
    function downloadTxt(name, text){
      const blob = new Blob([text], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name;
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }
    function importBase64(b64){
      try{
        const json = fromBase64(b64.trim());
        const data = JSON.parse(json);
        if(!data.tasks){ alert('Invalid backup'); return; }
        const proceed = confirm('Import will REPLACE current data. Continue?');
        if(!proceed) return;
        state = data;
        // Safety: ensure arrays exist
        state.orderBacklog ||= [];
        state.orderToday ||= [];
        render();
      }catch(e){
        console.error(e);
        alert('Failed to import. Make sure it is the Base64 backup text.');
      }
    }

    $('#btnExport').addEventListener('click', ()=> exportBase64());
    $('#btnCopy').addEventListener('click', async ()=>{
      const txt = $('#exportArea').value || exportBase64();
      try{ await navigator.clipboard.writeText(txt); alert('Copied Base64 to clipboard'); }catch{ alert('Copy failed'); }
    });
    $('#btnDownload').addEventListener('click', ()=>{
      const b64 = exportBase64();
      const stamp = new Date().toISOString().replace(/[:.]/g,'').replace(/-/g,'').slice(0,15);
      downloadTxt(`backlog-${stamp}.txt`, b64);
    });
    $('#btnImport').addEventListener('click', ()=>{
      const val = $('#exportArea').value.trim();
      if(!val){ alert('Paste a Base64 string into the textarea first.'); return; }
      importBase64(val);
    });
    $('#fileInput').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text(); importBase64(text);
      e.target.value='';
    });

    // Drag-and-drop file onto page
    document.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    document.addEventListener('drop', async (e)=>{
      if(!e.dataTransfer?.files?.length) return;
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      const text = await file.text();
      importBase64(text);
    });

    // ---------- Keyboard shortcuts ----------
    document.addEventListener('keydown', (e)=>{
      // Check if we're in a text input area OR if any contenteditable element is active
      const activeElement = document.activeElement;
      const isInInput = ['INPUT','TEXTAREA'].includes(activeElement.tagName) || 
                       activeElement.contentEditable === 'true' ||
                       activeElement.isContentEditable;
      
      // Skip keyboard shortcuts if we're editing text
      if(isInInput) return;
      
      if(e.key.toLowerCase()==='s'){ e.preventDefault(); state.session=!state.session; render(); }
      if(e.key.toLowerCase()==='n'){ e.preventDefault(); $('#taskInput').focus(); }
      if(e.key==='.' ){ // cycle priority on first selected/first task in Today
        e.preventDefault();
        const t = state.tasks.find(t=>t.today) || state.tasks[0];
        if(t){ t.pri=(t.pri+1)%3; t.updated=nowStamp(); render(); }
      }
      if(e.key.toLowerCase()==='t'){
        e.preventDefault();
        // toggle Today for the first backlog item
        const t = state.tasks.find(t=>!t.today);
        if(t){ t.today=true; if(!state.orderToday.includes(t.id)) state.orderToday.push(t.id); render(); }
      }
    });
    $('#showShortcuts').addEventListener('click', (e)=>{
      e.preventDefault();
      alert('Shortcuts:\nS Start/Stop session\nN New task\nT Toggle first backlog task to Today\n. Cycle priority on first Today task\nDouble‑click text to edit');
    });

    // Clock
    function tickClock(){
      const d = new Date();
      $('#clock').textContent = d.toLocaleString(undefined, {weekday:'short', hour:'2-digit', minute:'2-digit'});
    }
    setInterval(tickClock, 1000); tickClock();

    // ---------- Boot ----------
    load();
    setupDrops();
    render();

    // Ensure orders contain all ids
    function normalizeOrders(){
      const idsBacklog = state.tasks.filter(t=>!t.today).map(t=>t.id);
      const idsToday   = state.tasks.filter(t=> t.today).map(t=>t.id);
      state.orderBacklog = state.orderBacklog.filter(id=>idsBacklog.includes(id)).concat(idsBacklog.filter(id=>!state.orderBacklog.includes(id)));
      state.orderToday   = state.orderToday.filter(id=>idsToday.includes(id)).concat(idsToday.filter(id=>!state.orderToday.includes(id)));
    }
    normalizeOrders();
    render();
  </script>

</body>
</html>
